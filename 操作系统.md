### 操作系统引论

####  操作系统的定义

```ASN.1
os定义 : os是直接控制和管理`计算机硬件`、`软件资源`，合理的对各类作业进行调度，以方便以用户使用的`程序集合`。
```

#### 操作系统的目标
- 方便性
- 有效性
- 可扩充性
- 开放性
#### 操作系统的作用
- **os作为用户与计算机硬件系统之间的接口：**OS处于用户与计算机硬件系统之间 用户通过OS来使用计算机系统

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102090426411.png" alt="image-20221102090426411" style="zoom: 67%;" />

- **os作为计算机系统资源的管理者：**处理机管理、存储器管理、 设备管理、文件管理

- **os实现了对计算机资源的抽象：**

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102090705579.png" alt="image-20221102090705579" style="zoom: 67%;" />
#### 推动操作系统发展的主要动力
- 不断提高计算机资源利用率
- 方便用户
- 器件的不断更新换代
- 计算机体系结构的不断发展

#### 批处理系统定义（此框为额外添加）

- 用户使用系统提供的作业控制语言（JCL）来描述自己对作业运行的控制意图，并将这些控制信息连同作业一起提交给计算机。
- 由OS去控制、调度各作业的运行并输出结果。
- 由于作业进入系统后用户不在干预，从而提高了效率。

> 设计目标: 提高系统资源的使用效率；提高作业的吞吐量

#### 单道批处理系统

#### <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102091642169.png" alt="image-20221102091642169" style="zoom:50%;" />

- 单道批处理系统的处理过程 :

- 为实现对作业的连续处理，需要先把一批作业以脱机方式输入到磁带上，并在系统中配上监督程序(Monitor)，在它的控制下，使这批作业能一个接一个地连续处理。

- 单道批处理系统的缺点：
  - 系统中的资源得不到充分的利用。这是因为在内存中仅有一道程序，每逢该程序在运行中发出/0请求后，CPU便处于等待状态，必须在其1/0完成后才继续运行。又因1/O设备的低速性，更使CPU的利用率显著降低。

![image-20221102092207443](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102092207443.png)

#### 多道批处理系统

![image-20221102092146550](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102092146550.png)

- 多道程序设计
  - 在多道批处理系统中，用户所提交的作业都先存放在外存上并排成一个队列，称为“后备队列”;然后，由作业调度程序按一定的算法从后备队列中选择若干个作业调入内存，使它们共享CPU和系统中的各种资源。
  - 所以为了进一步提高资源的利用率和系统吞吐量，在20世纪60年代中期引入了多道程序设计技术，由此形成了多道批处理系统。

- 多道批处理系统的优缺点
  - 资源利用率高
  - 系统吞吐量大
  - 平均周转时间长
  - 无交互能力

 - 多道批处理系统的特征
   - 多道性
   - 无序性
   - 调度性

- 多道批处理系统需要解决的问题
  - **处理机争用问题（处理cpu的争用问题）：**既要能满足各道程序运行的需要，又要能提高处理机的利用率
  - **内存分配和保护问题：**系统应能为每道程序分配必要的 内存空间，使它们“各得其所” ，且不会因某道程序出现异常情 况而破坏其它程序
  - **I/O设备分配问题：**系统应采取适当的策略来分配系统中的I/O设备，以达到既能方便用户对设备的使用，又能提高设备利用率的目的
  - **文件的组织和管理问题：**系统应能有效地组织存放在系统中 的大量的程序和数据，使它们既便于用户使用，又能保证数 据的安全性
  - **作业管理问题：**系统中存在着各种作业(应用程序)，系统应 能对系统中所有的作业进行合理的组织，以满足这些作业用 户的不同要求
  - **用户与系统的接口问题：**为使用户能方便的使用操作系统， OS还应提供用户与OS之间的接口
  
#### 分时系统

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102092749261.png" alt="image-20221102092749261" style="zoom: 50%;" />

- 一台计算机连接多个终端，用户通过各自的终端把作业送入计算机;计算机又通过终端向各个用户报告其作业的运行情况。（理解）
- 计算机能分时轮流地为各终端用户服务，并能及时地对用户服务请求予以响应。（理解）
- 分时系统基本特征
  - 多路性
  - 独立性
  - 及时性
  - 交互性

#### 实时系统
```ASN.1
定义 : 提高系统的响应时间，对随机发生的外部事件作出及时响应并在规定的时间内对其进行处理。
```

- 实时任务，按任务执行时是否呈现周期性来划分
  - 周期性实时任务。
  - 非周期性实时任务。

- 都必须联系着一个截止时间(Deadline)。
  - 开始截止时间--任务在某时间以前必须开始执行
  - 完成截止时间--任务在某时间以前必须完成

- 根据对截止时间的要求来划分
  - 硬实时任务(hard real-time task) ： 系统必须满足任务对截止时间的要求，否则可能出现难以预测的结果
  - 软实时任务(Soft real-timetask) ： 它也联系着一个截止时间，但并不严格，若偶尔错过了任务的截止时间，对系统产生的影响也不会太大

- 实时系统基本特征
  - 快速的响应时间
  - 有限的交互能力
  - 高可靠性

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102093432889.png" alt="image-20221102093432889" style="zoom: 50%;" />

#### **并发**

- 并发:指两个或多个事件在同一时刻发生

- 并行:指两个或多个事件在同一时间间隔 (一个时钟周期) 内发生

#### 共享
- 指系统中的支援可供内存中多个并发执行的进程共同调用
- 互斥共享方式 : 如打印机，磁带机
- 同时访问方式 : 所谓的`同时`，在单处理机下是宏观意义上的，而在微观上，这些进程对该资源的访问是交替进行的。 如 : 磁盘

#### 虚拟
```ASN.1
通过某种技术将一个物理实体变为若干个逻辑上的对应物的功能称为`虚拟`
```

- 时分复用技术
  - 虚拟机处理技术
  - 虚拟设备技术

- 空分复用技术

#### 异步

```ASN.1
系统中并发执行的多道程序“走走停停”，以不可预知的速度向前推进
```

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102094051808.png" alt="image-20221102094051808" style="zoom: 67%;" />

#### 



### 进程的描述与控制

#### 前驱图

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102101846833.png" alt="image-20221102101846833" style="zoom: 33%;" />

#### 程序顺序执行

```ASN.1
一个程序由若干个程序段组成，而这些程序段的执行必须是顺序的，这种程序执行的方式就称为程序的顺序执行。
```

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102102108402.png" alt="image-20221102102108402" style="zoom: 50%;" />

**特征**

- 顺序性：处理机的操作严格按照程序所规定的顺序执行
- 封闭性：程序一旦开始执行，其计算结果不受外界因素的影响
- 可再现象：程序执行的结果与它的执行速度无关(即与时间无关)，而只与初始条件有关

#### 程序并发执行

- <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102102418971.png" alt="image-20221102102418971" style="zoom:50%;" />

I1、C1、P1的执行必须严格按照I1，C1，P1的顺序； 而 C1与 I2，P1与 C2、I3 是可以同时执行

**特征**

- 间断性
- 失去封闭性：程序在并发执行时，系统的资源状态由多道程序来改变，程序运 行失去封闭性。程序的运行受到其他程序的影响

- 不可再现性：程序在并发执行时，多次运行初始条件相同的同一程序会得出不同的运行结果

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102102910555.png" alt="image-20221102102910555" style="zoom: 50%;" />

#### 进程的定义和特征

- 进程的定义：程序关于某个数据集合的一次执行过程
- 进程的特征（与程序比较）
  - 结构特征：进程控制块 (PCB) + 程序 + 数据 = 进程实体
  - 动态性 (最基本的特征)
    - 进程：进程实体的一次执行过程，有生命周期
    - 程序：程序是一组有序指令的集合，是静态的概念
  - 并发性
  - 独立性
  - 异步性：进程各自独立的、以不可预知的速度向前推进

#### 进程的三种基本特征

- 就绪状态 (Ready)：进程已获得除CPU之外的所有必需的资源，一旦得到CPU的资源，立即可以运行
- 运行状态 (Running)：进程已获得运行所必需的资源，它正在处理机上执行
- 阻塞状态 (Blocked)：正在执行的进程由于发生某事件而暂时无法执行时，便放弃处理机而处于暂停状态，称该进程处于阻塞状态或等待状态

#### 三种基本状态的转换

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102121150800.png" alt="image-20221102121150800" style="zoom:50%;" />

#### 挂起操作和进程状态的转换

**挂起操作的引入**

- 终端用户的需要
- 父进程的请求
- 负荷调节的需要
- 操作系统的需要

**引入挂起原语后三个进程状态的转换**

- 活动就绪→静止就绪
- 活动就绪→静止阻塞
- 静止就绪→活动就绪
- 静止阻塞→活动阻塞

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102121832010.png" alt="image-20221102121832010" style="zoom:50%;" />

#### 进程管理中的数据结构

- **操作系统中用于管理控制的数据结构：**在计算机系统中，对于每个资源和每个进程都设置了一个数据结构，用于表征其实体，我们称之为进程信息表，其中包含了资源和进程的标识、描述、状态等信息以及一批指针。通过这些指针，可以将同一进程所占用的资源信息表分类链接成不同的队列，便于操作系统进行查找。

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102124554505.png" alt="image-20221102124554505" style="zoom:50%;" />

如上图，OS管理的这些数据结构一般分为以下四类：内存表、设备表、文件表和用于管理进程的进程表，通常进程表称为进程控制块PCB

**进程控制块PCB的作用**

- PCB作为进程实体的一部分，记录了操作系统所需的，用于描述进程的当前情况以及管理进程运行的全部信息，是操作系统中最重要的记录型数据结构
- 使一个在多道程序环境下不能独立运行的程序 (含数据) 成为一个能独立运行的基本单位，一个能与其他进程并发执行的进程

**进程控制块中的信息**

- 进程标识符
  - 外部标识符
  - 内部标识符
- 处理机状态：主要由处理机的各种寄存器中的内容组成。处理机运行时的 信息存放在寄存器中，当被中断时这些信息要存放在PCB中
- 进程调度信息
  - 进程状态
  - 进程优先级
  - 进程调度所需的其他信息
  - 事件
- 进程控制信息
  - 程序和数据的地址
  - 进程同步和通信机制
  - 资源清单
  - 链接指针

**进程控制块的组织方式**

- 线性方式：将系统中所有的PCB都组织在一张线性表中

- 链接方式：把具有相同状态进程的PCB分别通过PCB中的链接字链接成一个队列

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102130032432.png" alt="image-20221102130032432" style="zoom:33%;" />

- 索引方式：系统根据所有进程状态的不同，建立几张索引表，例如，就绪索引表、阻塞索引表

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102130424791.png" alt="image-20221102130424791" style="zoom:33%;" />

**操作系统内核**

```ASN.1
现代操作系统一般将OS划分为若干层次，再将OS的不同功能分别设置在不同的层次中。通常将一些与硬件紧密相关的模块（如中断处理程序等）、各种常用设备的驱动程序以及运行频率较高的模块 (如时钟管理、进程调度和许多模块所公用的一些基本操作)，都安排在紧靠硬件的层次中，将它们常驻内存，即通常被称为的OS内核。即“内核”指的是一个提供硬件抽象层、磁盘及文件系统控制、多任务等功能的系统软件
```

<img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102165740970.png" alt="image-20221102165740970" style="zoom:50%;" />

为了防止OS本身及关键数据 (如PCB等) 遭到应用程序有意或无意的破坏，通常也将处理机的执行状态分成系统态和用户态两种：系统态 (管态或内核态)，它具有较高的特权，能够执行一切指令，访问所有寄存器和存储区，传统的OS都在系统态运行。用户态：又称为目态。它是具有较低特权的执行状态，仅能执行规定的指令，访问指定的寄存器和存储区。一般情况下，应用程序只能在用户态运行，不能区执行OS指令及访问OS区域，这样可以防止应用程序对OS的破坏

总体而言，不同类型和规模的OS，它们的内核和所包含的功能间存在一定的差异，但大多数OS内核都包含了以下两大方面的功能：

- 支撑功能：该功能是提供给OS其他众多模块所需要的一些基本功能，以便支撑这些模块工作

  - 中断处理 (最基本功能)

  - 时钟管理

  - 原语操作

- 资源管理功能
  - 进程管理
  - 存储器管理
  - 设备管理

#### 进程的创建

- 进程的层次结构

  - 进程允许创建进程，创建进程的是父进程，被创建的是子进程，子进程继承父进程的一切，例如子进程继承父进程打开的文件，继承父进程所分配到的缓冲区，当子进程被撤销时，应归还继承的一切资源，撤销父进程时，也要撤销子进程，
  - 在PCB中设置了家族关系表项，以表明自己的父进程及所有的子进程。进程不能拒绝其子进程的继承权。
  - 注意，Windows中不存在任何进程层次结构的概念，所有的进程都具有相同的地位。
  - 如果一个进程创建另外一个进程时创建进程获得了一个句柄，其作用相当于一个令牌，可以用来控制被创建的继承。这个句柄是可以进行传递的，也就是说获得了句柄的进程就拥有控制其它进程的权力，因此，进程之间的关系不再是层次关系了，而是获得句柄与否、控制与被控制的简单关系

- 进程图 (描述进程关系)

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102190033021.png" alt="image-20221102190033021" style="zoom: 80%;" />

- 引起创建进程的事件

  - 用户登录：在分时系统中，用户在终端键入登录命令后，若登录成功，系统将为用户建立一个进程，并把它插入就绪队列
    - 分时系统：分时操作系统是使一台计算机采用时间片轮转的方式同时为几个、几十个甚至几百个用户服务的一种操作系统。

  - 作业调度：在多道批处理系统中，当作业调度程序按一定的算法调度到某个些作业时，便将它们装入内存，为它们创建进程，并把它们插入就绪队列中

  - 提供服务：当运行中的用户程序提出某种请求后，系统将专门创建一个进程来提供用户所需要的服务

  - 应用请求：以上三种情况都是由系统内核为用户创建的进程，而这类事件则是由用户进程自己创建新进程，以便使新进程以同创建者进程并发运行的方式完成特定的任务

- 进程的创建：每当系统发现要求创建新进程的事件后，OS便调用进程创建原语Creat()，创建新进程

  - 申请空白PCB

  - 为新进程分配资源

  - 初始化进程控制块

  - 将进程插入就绪队列

#### 进程的终止

- 引起进程终止的事件

  - 正常结束

  - 异常结束
    - 越界错误、非法指令

  - 外界干预
    - 操作员或操作系统干预
    - 父进程的请求
    - 父进程终止

- 进程的终止过程

  - 找出被终止进程的PCB

  - 若进程状态为运行态，终止该进程的执行，置CPU调度标志为真，用于指示该进程被终止后应重新进行调度

  - 若该进程有子孙进程，终止其子孙进程并回收其资源

  - 回收终止进程的资源

  - 将终止进程 (PCB) 从所在队列 (或链表) 中移除，等待其他程序来搜集

####  进程的阻塞与唤醒

- 引起进程阻塞和唤醒的事件

  - 向系统请求共享资源失败

  - 等待某种操作的完成

  - 新数据尚未到达

  - 等待新任务的到达

- 进程阻塞过程

  - 进程阻塞原语阻塞自己

  - 将PCB中的状态改为阻塞，并加入阻塞队列

  - 转进程调度

#### 进程的挂起与激活

- 进程的挂起
  - 若处于活动就绪状态，便将其改为静止就绪
  - 若处于活动阻塞状态的进程，则将之改为静止阻塞
  - 若挂起的进程正在执行，则转向调度程序重新调度

- 进程的激活：当发生激活进程的事件时，系统利用激活原语active()将指定 进程激活
  - 激活源于将进程从外村调入内存
  - 检测进程状态
    - 若为禁止就绪，就改为活动就绪
    - 若为静止阻塞，就改为活动阻塞

#### 进程同步的基本概念

进程同步机制的主要任务，是对多个相关进程在执行次序上进行协调，使并发执行的诸进程之间能按照一定的规则   或时序共享系统资源，并能很好地相互合作，从而使程序的执行具有可再现性

- 两种形式的制约关系

  - 间接相互制约关系（源于资源共享）
  - 直接相互制约关系（源于进程合作）

- 临界资源 (Critical Resouce)

  - 临界资源 (Critical Resouce)：把一段时间内只允许一个进程访问的资源称为临界资源或独占资源

  - 临界区 (Critical Section)：每个进程中访问临界资源的那段代码称为临界区

  - 生产者-消费者问题

    ![image-20221102200455864](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102200455864.png)

生产者进程和消费者进程都以异步方式运行，但它们之间必须保持同步

- 临界区 (Critical Section)：每个进程访问临界资源的那段代码称为临界区

  ```c
  While(TRUE)
  {
  	进入区 (进入临界资源)
  	临界区 (访问临界资源)
  	退出区 (退出临界资源)
  	剩余区 (了解即可)
  }
  ```

- 同步机制应遵循的规则 (互斥的访问临界资源)
  - 空闲让进
  - 忙则等待
  - 有限等待
  - 让权等待

#### 软件实现互斥的方法

- 单标志法：两个进程在访问完临界区后会把使用临界区的权限转交给另一个进程。也就是说每个进程进入临界区的权限只能被另一个进程赋予

  ![image-20221102221921785](C:\Users\学习\AppData\Roaming\Typora\typora-user-images\image-20221102221921785.png)

局限性：当临界资源空闲时，P1无法访问临界资源，这违背了空闲让进原则

- 双标志先检查法：设置一个布尔数组flag[]，数组中各个元素用来标记各进程想进入临界区的意愿，比如“flag[0] = true”意味着0号进程p0现在想要进入临界区。每个进程在进入临界区之前先检查当前有没有别的进程想要进入临界区，如果没有，则把自身对应的标志flag[i]设置为TRUE，之后开始访问临界区

  ![image-20221102223842301](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102223842301.png)

- 双标志后检查法

  ![image-20221102224446169](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102224446169.png)

- PeterSon (皮特森) 算法：两个进程都表示自己想要进入临界区的想法，并且也会有一个标志位来表示该进程可以将进入临界区的权利优先让给另一个进程。从而来达到各个进程都可以在遵循进程互斥和进程同步的规则下访问临界区。

  <img src="https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102230421680.png" alt="image-20221102230421680" style="zoom: 67%;" />

![image-20221102231403771](https://2114301743-1314609253.cos.ap-nanjing.myqcloud.com/img/image-20221102231403771.png)

#### 硬件实现互斥的方法

- 关中断：进入锁测试之前关闭中断，直到完成锁测试并上锁之后才能打开中断。这样，进程在临界区执行期间，计算机系统不响应中断，从而不会引发调度，也就不会发生进程或线程切换。
  - 滥用关中断权力可能导致严重后果
  - 关中断时间过长，会影响系统效率，限制了处理器交叉执行程序的能力
  - 关中断不适用于多CPU系统，因为在一个处理器上关中断并不能防止进程在其他处理器上执行相同的临界段代码
- 利用Test-and-Set指令实现互斥
- 利用Swap指令实现进程互斥

#### 信号量机制

- 整型信号量：整型信号量定义为一个用于表示资源数目的整型量S，它与一般整型量不同，除初始化外，仅能通过两个标准的原子操作wait(S)和signal(S)来访问，这两个操作被分别称为P、V操作

~~~c
//整型信号量，表示可用资源数
int S = 1;
//wait原语，相当于进入区
void wait(int S){
	//资源不够，循环等待
	while(S <= 0);
	S = S -1;
}
//signal原语，相当于退出区
void signal(int S){
	S = S + 1;
}
-----------------------------------------------------------------------------------------
//进程Pn
````
wait(S);             //进入区，申请打印机
访问共享资源;          //临界区，访问打印机
signal(S);           //退出区，释放打印机
````
~~~

整型信号量违背让权等待原则，会发生忙等

- 记录型信号量：进程进入阻塞状态，不会忙等

  ```c
  //记录型信号量定义
  typedef struct{
      int value;
      struct process* L;
  }semaphore
      
  void wait(semaphore S){
  	S.value--;
      if(S.value < 0){
  		//block原语阻塞进程
          block(S.L);
      }
  }
  
  void signal(semaphore S){
  	S.value++;
      if(S.value <= 0){
  		//wakeup原语唤醒进程
          wakeup(S.L);
      }
  }
  --------------------------------------------------------------------------------------注意进程唤醒是一次性将所有阻塞的进程唤醒，然后插入就绪队列中，部分会因为获得处理机调度而执行，还有一部分会因为资源被占用而重新加入阻塞队列中
  --------------------------------------------------------------------------------------
      很多时候，进程的执行需要很多资源，假如出现以下情况两个进程A和B，它们都要访问共享资源D和E
      process A:			process B:
  	wait(Dmutex);		wait(Emutex);
  	wait(Emutex);		wait(Dmutex);
  在无外力的作用下，进程A和B会进入死锁状态
  ```

- AND型信号量
